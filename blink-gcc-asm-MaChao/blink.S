; 闪烁 Arduino Uno 上的板载 LED
;
; 延时方法来自《AVR 单片机嵌入式系统原理与应用实践》 马潮 编著
;
; 扩展名用 .S 是方便用 gcc 的预处理器 cpp 对汇编源文件进行处理
; 这样可以用 #include #define 等指令
;
; TODO
; 应该写一个 blink without delay 的例子，用 Timer
;
; 参考
; [1] https://www.cypherpunk.at/2015/11/assembler-on-arduino-part-2/

#include <avr/io.h>

; 下面这些寄存器/常量定义在 <avr/io.h> 中
;.equ PORTB, 0x05
;.equ DDRB,  0x04
;.equ PINB,  0x03
;.equ SPH,   0x3E
;.equ SPL,   0x3D
;.equ RAMEND, 0x8FF


.org 0x0000    ; the next instruction has to be written to address 0x0000
    rjmp START ; the reset vector: jump to "main"
               ; here we ignore the interrupt vectors

START:         ; this is a label "START"


    ; reset system status register
    ldi r16, 0
    out _SFR_IO_ADDR(SREG), r16

    ldi r16, lo8(RAMEND)       ; init stack pointer
    out _SFR_IO_ADDR(SPL), r16

    ldi r16, hi8(RAMEND)
    out _SFR_IO_ADDR(SPH), r16

    ldi r16, 0b00100000
    out _SFR_IO_ADDR(DDRB),  r16  ; set PB5 to output mode
    out _SFR_IO_ADDR(PORTB), r16  ; high, LED off

    ldi r16, 249  ; 设置 500ms 延时参数

; infinite loop
LOOP:
    sbi _SFR_IO_ADDR(PORTB), 5 ; switch off the LED
    rcall delay                ; wait for 0.5s (500 ms)
    cbi _SFR_IO_ADDR(PORTB), 5 ; switch it on
    rcall delay                ; wait for 0.5s (500 ms)
    rjmp LOOP                  ; "Relative JuMP" to LOOP


; 通用延时子程序控制常数与延时周期和时间
; 《AVR 单片机嵌入式系统原理与应用实践》Page 113
; 计算方法:
;                     x                    x    i                   
;                   _____                ____  ____                 
;                   \    /        \      \     \    /        \  
; T = 11 + 7x -1 +  /___ | 7i - 1 |  +   /___  /___ | 3j - 1 |      
;                    i=1 \        /       i=1  j=1  \        /     
;
; F_CPU = 16000000 Hz
; 机器周期 t = 0.062500 us
; 时间单位: us
;  x        T    Delay_Time    x        T    Delay_Time    x        T    Delay_Time    x        T    Delay_Time  
; -------------------------------------------------------------------------------------------------------------
;  1       25        1.5625   65   156985     9811.5625  129  1149529    71845.5625  193  3764089   235255.5625  
;  2       52        3.2500   66   164020    10251.2500  130  1175860    73491.2500  194  3822004   238875.2500  
;  3       94        5.8750   67   171262    10703.8750  131  1202590    75161.8750  195  3880510   242531.8750  
;  4      154        9.6250   68   178714    11169.6250  132  1229722    76857.6250  196  3939610   246225.6250  
;  5      235       14.6875   69   186379    11648.6875  133  1257259    78578.6875  197  3999307   249956.6875  
;  6      340       21.2500   70   194260    12141.2500  134  1285204    80325.2500  198  4059604   253725.2500  
;  7      472       29.5000   71   202360    12647.5000  135  1313560    82097.5000  199  4120504   257531.5000  
;  8      634       39.6250   72   210682    13167.6250  136  1342330    83895.6250  200  4182010   261375.6250  
;  9      829       51.8125   73   219229    13701.8125  137  1371517    85719.8125  201  4244125   265257.8125  
; 10     1060       66.2500   74   228004    14250.2500  138  1401124    87570.2500  202  4306852   269178.2500  
; 11     1330       83.1250   75   237010    14813.1250  139  1431154    89447.1250  203  4370194   273137.1250  
; 12     1642      102.6250   76   246250    15390.6250  140  1461610    91350.6250  204  4434154   277134.6250  
; 13     1999      124.9375   77   255727    15982.9375  141  1492495    93280.9375  205  4498735   281170.9375  
; 14     2404      150.2500   78   265444    16590.2500  142  1523812    95238.2500  206  4563940   285246.2500  
; 15     2860      178.7500   79   275404    17212.7500  143  1555564    97222.7500  207  4629772   289360.7500  
; 16     3370      210.6250   80   285610    17850.6250  144  1587754    99234.6250  208  4696234   293514.6250  
; 17     3937      246.0625   81   296065    18504.0625  145  1620385   101274.0625  209  4763329   297708.0625  
; 18     4564      285.2500   82   306772    19173.2500  146  1653460   103341.2500  210  4831060   301941.2500  
; 19     5254      328.3750   83   317734    19858.3750  147  1686982   105436.3750  211  4899430   306214.3750  
; 20     6010      375.6250   84   328954    20559.6250  148  1720954   107559.6250  212  4968442   310527.6250  
; 21     6835      427.1875   85   340435    21277.1875  149  1755379   109711.1875  213  5038099   314881.1875  
; 22     7732      483.2500   86   352180    22011.2500  150  1790260   111891.2500  214  5108404   319275.2500  
; 23     8704      544.0000   87   364192    22762.0000  151  1825600   114100.0000  215  5179360   323710.0000  
; 24     9754      609.6250   88   376474    23529.6250  152  1861402   116337.6250  216  5250970   328185.6250  
; 25    10885      680.3125   89   389029    24314.3125  153  1897669   118604.3125  217  5323237   332702.3125  
; 26    12100      756.2500   90   401860    25116.2500  154  1934404   120900.2500  218  5396164   337260.2500  
; 27    13402      837.6250   91   414970    25935.6250  155  1971610   123225.6250  219  5469754   341859.6250  
; 28    14794      924.6250   92   428362    26772.6250  156  2009290   125580.6250  220  5544010   346500.6250  
; 29    16279     1017.4375   93   442039    27627.4375  157  2047447   127965.4375  221  5618935   351183.4375  
; 30    17860     1116.2500   94   456004    28500.2500  158  2086084   130380.2500  222  5694532   355908.2500  
; 31    19540     1221.2500   95   470260    29391.2500  159  2125204   132825.2500  223  5770804   360675.2500  
; 32    21322     1332.6250   96   484810    30300.6250  160  2164810   135300.6250  224  5847754   365484.6250  
; 33    23209     1450.5625   97   499657    31228.5625  161  2204905   137806.5625  225  5925385   370336.5625  
; 34    25204     1575.2500   98   514804    32175.2500  162  2245492   140343.2500  226  6003700   375231.2500  
; 35    27310     1706.8750   99   530254    33140.8750  163  2286574   142910.8750  227  6082702   380168.8750  
; 36    29530     1845.6250  100   546010    34125.6250  164  2328154   145509.6250  228  6162394   385149.6250  
; 37    31867     1991.6875  101   562075    35129.6875  165  2370235   148139.6875  229  6242779   390173.6875  
; 38    34324     2145.2500  102   578452    36153.2500  166  2412820   150801.2500  230  6323860   395241.2500  
; 39    36904     2306.5000  103   595144    37196.5000  167  2455912   153494.5000  231  6405640   400352.5000  
; 40    39610     2475.6250  104   612154    38259.6250  168  2499514   156219.6250  232  6488122   405507.6250  
; 41    42445     2652.8125  105   629485    39342.8125  169  2543629   158976.8125  233  6571309   410706.8125  
; 42    45412     2838.2500  106   647140    40446.2500  170  2588260   161766.2500  234  6655204   415950.2500  
; 43    48514     3032.1250  107   665122    41570.1250  171  2633410   164588.1250  235  6739810   421238.1250  
; 44    51754     3234.6250  108   683434    42714.6250  172  2679082   167442.6250  236  6825130   426570.6250  
; 45    55135     3445.9375  109   702079    43879.9375  173  2725279   170329.9375  237  6911167   431947.9375  
; 46    58660     3666.2500  110   721060    45066.2500  174  2772004   173250.2500  238  6997924   437370.2500  
; 47    62332     3895.7500  111   740380    46273.7500  175  2819260   176203.7500  239  7085404   442837.7500  
; 48    66154     4134.6250  112   760042    47502.6250  176  2867050   179190.6250  240  7173610   448350.6250  
; 49    70129     4383.0625  113   780049    48753.0625  177  2915377   182211.0625  241  7262545   453909.0625  
; 50    74260     4641.2500  114   800404    50025.2500  178  2964244   185265.2500  242  7352212   459513.2500  
; 51    78550     4909.3750  115   821110    51319.3750  179  3013654   188353.3750  243  7442614   465163.3750  
; 52    83002     5187.6250  116   842170    52635.6250  180  3063610   191475.6250  244  7533754   470859.6250  
; 53    87619     5476.1875  117   863587    53974.1875  181  3114115   194632.1875  245  7625635   476602.1875  
; 54    92404     5775.2500  118   885364    55335.2500  182  3165172   197823.2500  246  7718260   482391.2500  
; 55    97360     6085.0000  119   907504    56719.0000  183  3216784   201049.0000  247  7811632   488227.0000  
; 56   102490     6405.6250  120   930010    58125.6250  184  3268954   204309.6250  248  7905754   494109.6250  
; 57   107797     6737.3125  121   952885    59555.3125  185  3321685   207605.3125  249  8000629   500039.3125  
; 58   113284     7080.2500  122   976132    61008.2500  186  3374980   210936.2500  250  8096260   506016.2500  
; 59   118954     7434.6250  123   999754    62484.6250  187  3428842   214302.6250  251  8192650   512040.6250  
; 60   124810     7800.6250  124  1023754    63984.6250  188  3483274   217704.6250  252  8289802   518112.6250  
; 61   130855     8178.4375  125  1048135    65508.4375  189  3538279   221142.4375  253  8387719   524232.4375  
; 62   137092     8568.2500  126  1072900    67056.2500  190  3593860   224616.2500  254  8486404   530400.2500  
; 63   143524     8970.2500  127  1098052    68628.2500  191  3650020   228126.2500  255  8585860   536616.2500  
; 64   150154     9384.6250  128  1123594    70224.6250  192  3706762   231672.6250  256  8686090   542880.6250 

delay:
    push r16  ; (2t)

del1:
    push r16  ; (2t)

del2:
    push r16  ; (2t)

del3:
    dec r16   ; (1t)
    brne del3 ; 不为 0 跳转到 del3; 为 0 顺序执行 (2t/1t)
    pop r16   ; (2t)
    dec r16   ; (1t)
    brne del2 ; 不为 0 跳转到 del2; 为 0 顺序执行 (2t/1t)
    pop r16   ; (2t)
    dec r16   ; (1t)
    brne del1 ; 不为 0 跳转到 del1; 为 0 顺序执行 (2t/1t)
    pop r16   ; (2t)
    ret       ; 子程序返回 (4t)

